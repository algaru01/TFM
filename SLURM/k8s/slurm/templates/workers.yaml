apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ include "slurm.workers.baseHostname" . }}
spec:
  selector:
    matchLabels:
      type: compute-node
  serviceName: {{ .Release.Name }}-workers-service
  replicas: {{ .Values.workers.numReplicas }}
  template:
    metadata:
      labels:
        type: compute-node
    spec:
      initContainers:
      - name: wait-for-frontend
        image: busybox
        command: ["sh","-c"]
        args: ["until nc -zv {{ include "slurm.frontend.hostname" . }} {{ .Values.frontend.slurmctldPort }};
                do
                  echo '-- db node ({{ include "slurm.frontend.hostname" . }}) is not available.  Sleeping ...';
                  sleep 5;
                done"] 
      containers:
        - name: {{ include "slurm.workers.baseHostname" . }}
          image: agalrui/debian-slurm-cn
          # command: ["tail", "-f", "/dev/null"] 
          command: ["/bin/sh", "/tmp/startup/startup-cn.sh"]

          volumeMounts:
            - name: config-volume
              mountPath: /etc/slurm/
            - name: startup-volume
              mountPath: /tmp/startup/
            - name: nfs
              mountPath: /shared-vol
      volumes:
        - name: nfs
          persistentVolumeClaim:
            claimName: nfs-pvc
        - name: config-volume
          configMap:
            defaultMode: 0777
            name: {{ .Release.Name }}-slurm-conf
            items:
            - key: slurm.conf
              path: slurm.conf
            - key: cgroup.conf
              path: cgroup.conf
        - name: startup-volume
          configMap:
            defaultMode: 0777
            name: {{ .Release.Name }}-startup
            items:
            - key: startup-cn.sh
              path: startup-cn.sh
      

---

apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-workers-service
spec:
  selector:
    type: compute-node
  ports:
    - name: listen
      port: {{ .Values.workers.slurmdPort }}
      targetPort: {{ .Values.workers.slurmdPort }}
