apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ include "slurm.workers.baseHostname" . }}
spec:
  selector:
    matchLabels:
      type: compute-node
  serviceName: {{ .Release.Name }}-workers-service
  replicas: {{ .Values.workers.numReplicas }}
  template:
    metadata:
      labels:
        type: compute-node
    spec:
      initContainers:
      - name: wait-for-frontend
        image: busybox
        command: ["sh","-c"]
        args: ["until nc -zv {{ include "slurm.frontend.hostname" . }} {{ .Values.frontend.slurmctldPort }};
                do
                  echo '-- db node ({{ include "slurm.frontend.hostname" . }}) is not available.  Sleeping ...';
                  sleep 5;
                done"] 
      containers:
        - name: {{ include "slurm.workers.baseHostname" . }}
          image: agalrui/debian-slurm-cn:{{ if .Values.benchmark }}benchmark{{ else }}latest{{ end }}
          # command: ["tail", "-f", "/dev/null"] 
          command: ["/bin/sh", "/tmp/startup/startup-cn.sh"]

          # resources:
          #   requests:
          #     memory: "2Gi" # Memoria/numReplicas
          #     cpu: "2" # Nucleos/numReplicas
          #   limits:
          #     memory: "2Gi"
          #     cpu: "2"

          volumeMounts:
            - name: config-volume
              mountPath: /etc/slurm/
            - name: config-users-volume
              mountPath: /etc/passwd
              subPath: passwd
            - name: config-users-volume
              mountPath: /etc/shadow
              subPath: shadow
            - name: config-users-volume
              mountPath: /etc/group
              subPath: group
            - name: config-users-volume
              mountPath: /etc/gshadow
              subPath: gshadow
            - name: startup-volume
              mountPath: /tmp/startup/
            {{- range .Values.users }}
            - name: nfs-users-{{ .username }}
              mountPath: /home/{{ .username }}
            {{- end }}
      volumes:
        {{- range .Values.users }}
        - name: nfs-users-{{ .username }}
          persistentVolumeClaim:
            claimName: pvc-users-{{ .username }}
        {{- end }}
        - name: config-volume
          configMap:
            defaultMode: 0777
            name: {{ .Release.Name }}-slurm-conf
            items:
            - key: slurm.conf
              path: slurm.conf
            - key: cgroup.conf
              path: cgroup.conf
        - name: config-users-volume
          configMap:
            defaultMode: 0777
            name: {{ .Release.Name }}-users-config
        - name: startup-volume
          configMap:
            defaultMode: 0777
            name: {{ .Release.Name }}-startup
            items:
            - key: startup-cn.sh
              path: startup-cn.sh
      

---

apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-workers-service
spec:
  selector:
    type: compute-node
  ports:
    - name: listen
      port: {{ .Values.workers.slurmdPort }}
      targetPort: {{ .Values.workers.slurmdPort }}
