apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-slurm-conf
data:
  slurm.conf: |
    # slurm.conf file generated by configurator.html.
    # Put this file on all nodes of your cluster.
    # See the slurm.conf man page for more information.
    #
    ClusterName=clusterTFM
    SlurmctldHost={{ include "slurm.frontend.hostname" . }}
    #
    #DisableRootJobs=NO
    #EnforcePartLimits=NO
    #Epilog=
    #EpilogSlurmctld=
    #FirstJobId=1
    #MaxJobId=67043328
    #GresTypes=
    #GroupUpdateForce=0
    #GroupUpdateTime=600
    #JobFileAppend=0
    #JobRequeue=1
    #JobSubmitPlugins=lua
    #KillOnBadExit=0
    #LaunchType=launch/slurm
    #Licenses=foo*4,bar
    #MailProg=/bin/mail
    #MaxJobCount=10000
    #MaxStepCount=40000
    #MaxTasksPerNode=512
    #MpiDefault=
    #MpiParams=ports=#-#
    #PluginDir=
    #PlugStackConfig=
    #PrivateData=jobs
    ProctrackType=proctrack/linuxproc
    #Prolog=
    #PrologFlags=
    #PrologSlurmctld=
    #PropagatePrioProcess=0
    #PropagateResourceLimits=
    #PropagateResourceLimitsExcept=
    #RebootProgram=
    ReturnToService=1
    SlurmctldPidFile=/var/run/slurm/slurmctld.pid
    SlurmctldPort={{ .Values.frontend.slurmctldPort }}
    SlurmdPidFile=/var/run/slurm/slurmd.pid
    SlurmdPort={{ .Values.workers.slurmdPort }}
    SlurmdSpoolDir=/var/spool/slurmd
    SlurmUser=slurm
    #SlurmdUser=root
    #SrunEpilog=
    #SrunProlog=
    StateSaveLocation=/var/spool/slurmctld
    #SwitchType=
    #TaskEpilog=
    #TaskPlugin=
    #TaskProlog=
    #TopologyPlugin=topology/tree
    #TmpFS=/tmp
    #TrackWCKey=no
    #TreeWidth=
    #UnkillableStepProgram=
    #UsePAM=0
    #
    #
    # TIMERS
    #BatchStartTimeout=10
    #CompleteWait=0
    #EpilogMsgTime=2000
    #GetEnvTimeout=2
    #HealthCheckInterval=0
    #HealthCheckProgram=
    InactiveLimit=0
    KillWait=30
    #MessageTimeout=10
    #ResvOverRun=0
    MinJobAge=300
    #OverTimeLimit=0
    SlurmctldTimeout=120
    SlurmdTimeout=300
    #UnkillableStepTimeout=60
    #VSizeFactor=0
    Waittime=0
    #
    #
    # SCHEDULING
    #DefMemPerCPU=0
    #MaxMemPerCPU=0
    #SchedulerTimeSlice=30
    SchedulerType=sched/backfill
    SelectType=select/cons_tres
    #
    #
    # JOB PRIORITY
    #PriorityFlags=
    #PriorityType=priority/multifactor
    #PriorityDecayHalfLife=
    #PriorityCalcPeriod=
    #PriorityFavorSmall=
    #PriorityMaxAge=
    #PriorityUsageResetPeriod=
    #PriorityWeightAge=
    #PriorityWeightFairshare=
    #PriorityWeightJobSize=
    #PriorityWeightPartition=
    #PriorityWeightQOS=
    #
    #
    # LOGGING AND ACCOUNTING
    
    {{- if .Values.db.enabled }}
      #AccountingStorageEnforce=0
      AccountingStorageHost={{ include "slurm.db.hostname" . }}
      AccountingStoragePass=/var/run/munge/munge.socket.2
      AccountingStoragePort={{ .Values.db.slurmdbdPort }}
      AccountingStorageType=accounting_storage/slurmdbd
      AccountingStorageUser=slurm
      #AccountingStoreFlags=
    {{- end }}

    #JobCompHost=
    #JobCompLoc=
    #JobCompParams=
    #JobCompPass=
    #JobCompPort=
    JobCompType=jobcomp/none
    #JobCompUser=
    #JobContainerType=
    JobAcctGatherFrequency=30
    #JobAcctGatherTypejobacct_gather/linux=
    SlurmctldDebug=info
    SlurmctldLogFile=/var/log/slurm/slurmctld.log
    SlurmdDebug=info
    SlurmdLogFile=/var/log/slurm/slurmd.log
    #SlurmSchedLogFile=
    #SlurmSchedLogLevel=

    # Usamos esta flag porque hc y cn tienen slurm.conf distintos
    DebugFlags=NO_CONF_HASH

    #
    #
    # POWER SAVE SUPPORT FOR IDLE NODES (optional)
    #SuspendProgram=
    #ResumeProgram=
    #SuspendTimeout=
    #ResumeTimeout=
    #ResumeRate=
    #SuspendExcNodes=
    #SuspendExcParts=
    #SuspendRate=
    #SuspendTime=
    #
    #
    # COMPUTE NODES
    #NodeName=DEFAULT CPUs=1 State=UNKNOWN
    # You can specify a default node and specific nodes
    NodeName={{ include "slurm.workers.baseHostname" . }}-[0-{{ .Values.workers.numReplicas }}] NodeHostname={{ include "slurm.workers.baseHostname" . }}-[0-{{ .Values.workers.numReplicas }}].{{ include "slurm.workers.service.fqdn" . }} CPUs=1 State=UNKNOWN
    PartitionName=debug Nodes=ALL Default=YES MaxTime=INFINITE State=UP
    # PartitionName=debug Nodes=ALL Default=YES MaxTime=INFINITE State=UP

{{- if .Values.db.enabled }}
  slurmdbd.conf: |
    DbdHost={{ include "slurm.db.hostname" . }}
    DbdPort= {{ .Values.db.slurmdbdPort }}
    StorageType=accounting_storage/mysql
    SlurmUser=slurm
    StoragePass={{ .Values.db.mySqlPassword }}
{{- end }}

  cgroup.conf: |
    ###
    # Slurm cgroup support configuration file.
    ###
    ConstrainCores=yes
    ConstrainDevices=yes
    ConstrainRAMSpace=yes
    ConstrainSwapSpace=yes
    CgroupPlugin=cgroup/v1


---

apiVersion: v1
kind: Secret
metadata:
  name: mysql-secret
type: Opaque
immutable: true
data:
  password: {{ .Values.db.mySqlPassword | b64enc }}